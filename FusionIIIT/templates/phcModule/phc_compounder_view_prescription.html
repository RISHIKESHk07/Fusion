{% extends 'globals/base.html' %}
{% load static %}

{% block title %}
    Home
{% endblock %}

{% block body %}
    <link href="https://cdn.rawgit.com/mdehoog/Semantic-UI/6e6d051d47b598ebab05857545f242caf2b4b48c/dist/semantic.min.css" rel="stylesheet" type="text/css" />

    {% block navBar %}
        {% include 'dashboard/navbar.html' %}
    {% endblock %}

    {% comment %}The grid starts here!{% endcomment %}
    <div class="ui stackable doubling grid">

        {% comment %}The left-margin segment!{% endcomment %}
        <div class="column"></div>

        {% comment %}The left-rail segment starts here!{% endcomment %}
        <div class="three wide column">

            {% comment %}ROW #1 starts here!{% endcomment %}
            <div class="row">
                {% comment %}The Employee Image Card starts here!{% endcomment %}
                {% block userCard %}
                    {% include 'globals/usercard.html' %}
                {% endblock %}
                {% comment %}The Employee Image Card ends here!{% endcomment %}
            </div>
            {% comment %}ROW #1 ends here!{% endcomment %}

            <div class="ui divider"></div>

            {% comment %}ROW #2 starts here!{% endcomment %}
            <div class="row">
                {% comment %}The Tab-Menu starts here!{% endcomment %}
                <div class="ui large fluid vertical pointing menu">

                    <a class=" active item" href="{% url 'healthcenter:compounder_view' %}">
                        health center
                        <i class="right floated chevron right icon"></i>
                    </a>
                </div>
                {% comment %}The Tab-Menu ends here!{% endcomment %}

            </div>
            {% comment %}ROW #2 ends here!{% endcomment %}

        </div>
        {% comment %}The left-rail segment ends here!{% endcomment %}

        {% comment %}The central-rail segment starts here!{% endcomment %}
        <div class="eight wide column">

            {% comment %}The ap `pointment approval tab starts here!{% endcomment %}
            <div class="ui active tab segment" style='height:650px;width:820px;overflow-x:scroll'>
                {% block patientlog %}
                <div class="ui vertical stripe team segment"
                style="padding-left: 3.5%;
                   padding-right: 3.5%;">
   
               <form class="ui form" method="POST">{% csrf_token %}
                   <div class="two fields">
                     <div class="field">
                         <label>User</label>
                         <div class="ui fluid large input">
                             <input placeholder="User Id" value="{{prescription.user_id}}" id="user" name="user" type="text" readonly>
                         </div>
                      </div>
   
                      <div class="field">
                          <label>Doctor</label>
                          <input placeholder="User Id" value="{{prescription.doctor_id}}" id="doctor" name="doctor" type="text" readonly>
                          </select>
                       </div>
                   </div>
                   <div class="field" >
                        <label>Date</label>
                        <input name="date" id="date" value="{{prescription.date}}" readonly></input>
                    </div>
                   {% if prescription.is_dependent == True %}
                   <div id="dependent_hide">
                       <div class="field">
                           <label>dependent name</label>
                           <input placeholder="dependent_name" value="{{prescription.dependent_name}}" id="" name="" type="text" readonly>
                       </div>
                       <div class="field">
                           <label>dependent relation</label>
                           <input placeholder="dependent_relation" value="{{prescription.dependent_relation}}" id="" name="" type="text" readonly>
                       </div>
                   </div>
                   {% endif %}
   
                   <div class="field">
                       <label>Detail of Disease</label>
                       <textarea name="details" id="details" rows="2" readonly>{{prescription.details}}</textarea>
                   </div>


                   <!-- <div class="two fields">
                     <div class="field">
                         <label>Medicine</label>
   
                           <select class="ui search fluid dropdown" id="medicine_id_b" name="medicine_id_b" required="true">
                           <option value="" disabled selected>--SELECT--</option>
                           {% for medicine in medicine %}  
                           <option value="{{medicine.id}}">{{medicine.medicine_name}}</option>
                           {% endfor %}
                         </select>
                     </div>
   
                      <div class="field">
                        <label>Quantity</label>
                        <div class="ui fluid large input">
                            <input placeholder="Quantity" id="quantity_b" name="quantity_b" type="number">
   
                        </div>
                     </div>
                       <div class="field">
                         <label>No of days</label>
                         <div class="ui fluid large input">
                             <input placeholder="No of days" id="days_b" name="days_b" type="number">
   
                         </div>
                        </div>
                        <div class="field">
                          <label>Times per day</label>
                          <div class="ui fluid large input">
                              <input placeholder="No of times per day" id="times_b" name="times_b" type="number">
   
                          </div>
                       </div>
                       <div class="field">
                           <label>Stock</label>
                           <select class="ui search fluid dropdown" name="stock_b" id="stock_b" required="true">
                               <option value="" disabled selected>--SELECT--</option>
                             </select>
                        </div>
                        <div class="field">
                            <label><br></label>
                            <input type="button" id="medicine_b" name="medicine_b" value="Add"class="ui small left floated primary button" />
   
                        </div>
                   </div> -->
                   <table  class="ui very basic collapsing celled small fluid sortable table"
                          style="padding-left: 2.5%;padding-right: 2.5%;margin: auto;">
                       <thead>
                       <tr>
                           <th class="two wide">
                               Medicine
                           </th>
   
                           <th class="two wide" >
                               Quantity
                           </th>
   
                           <th class="wide">
                               Days
                           </th>
                           <th class="wide">
                               Times
                           </th>
                           <th class="wide">
                               Stock
                           </th>
                       </tr>
                       </thead>
   
                       <tbody id="">
                        {% for med in pre_medicine %}
                        {% if med.prescription_followup_id == None %}
                        <tr>
                            <td>
                                {{med.medicine_id}}
                            </td>
                            <td>
                                {{med.quantity}}
                            </td>
                            <td>
                                {{med.days}}
                            </td>
                            <td>
                                {{med.times}}
                            </td>
                            <td>
                                {{med.stock}}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                       </tbody>
                   </table>
                   <div class="field">
                       <label>Tests Suggested</label>
                       <textarea rows="2" id="" name="" readonly>{{prescription.test}}</textarea>
                   </div>
                   <div class="field">
                </form>
                {% for f_pres in follow_presc %}
                <form>
                    <div>
                        followup
                        <br>
                    </div>
                    <div class="field">
                        <label>Doctor</label>
                        <input placeholder="User Id" value="{{f_pres.Doctor_id}}" id="doctor" name="doctor" type="text" readonly>
                        </select>
                 </div>
                 <div class="field" >
                      <label>Date</label>
                      <input name="date" id="date" value="{{f_pres.date}}" readonly></input>
                  </div>
                  <div class="field">
                    <label>Detail of Disease</label>
                    <textarea name="details" id="details" rows="2" readonly>{{f_pres.details}}</textarea>
                </div>
                <table  class="ui very basic collapsing celled small fluid sortable table"
                          style="padding-left: 2.5%;padding-right: 2.5%;margin: auto;">
                       <thead>
                       <tr>
                           <th class="two wide">
                               Medicine
                           </th>
   
                           <th class="two wide" >
                               Quantity
                           </th>
   
                           <th class="wide">
                               Days
                           </th>
                           <th class="wide">
                               Times
                           </th>
                           <th class="wide">
                               Stock
                           </th>
                       </tr>
                       </thead>
   
                       <tbody id="">
                        {% for med in pre_medicine %}
                        {% if med.prescription_followup_id.id == f_pres.id %}
                        <tr>
                            <td>
                                {{med.medicine_id}}
                            </td>
                            <td>
                                {{med.quantity}}
                            </td>
                            <td>
                                {{med.days}}
                            </td>
                            <td>
                                {{med.times}}
                            </td>
                            <td>
                                {{med.stock}}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                       </tbody>
                   </table>
                   <div class="field">
                    <label>Tests Suggested</label>
                    <textarea rows="2" id="" name="" readonly>{{f_pres.test}}</textarea>
                </div>

                </form>
                <br>
                {% endfor %}
                <div class="field">
                    <label><br></label>
                    <input type="button" id="add_followup" name=""  value="add_followup" class="ui large right floated primary button" />               
                    </div>
               <div>
                <form id="followup_form" class="ui form" method="POST">{% csrf_token %}
                    <p id="usr_b"></p>
                       <div class="field">
                        <label>Doctor</label>
                        <select class="ui search fluid dropdown" name="doctor_b" id="doctor_b" required="true">
                          <option value="" disabled selected>--SELECT--</option>
                          {% for doctor in doctors %}
                          <option value="{{doctor.id}}">{{doctor.doctor_name}}</option>
                          {% endfor %}
                        </select>
                        </div>
    
                    <div class="field">
                        <label>Detail of Disease</label>
                        <textarea name="details" id="details_b" rows="2"></textarea>
                    </div>

                    <table  class="ui very basic collapsing celled small fluid sortable table"
                           style="padding-left: 2.5%;padding-right: 2.5%;margin: auto;">
                        <thead>
                        <tr>
                            <th class="two wide">
                                Medicine id
                            </th>
                            <th class="two wide">
                                Medicine
                            </th>
    
                            <th class="two wide" >
                                Quantity
                            </th>
    
                            <th class="wide">
                                Days
                            </th>
                            <th class="wide">
                                Times
                            </th>
                            <th class="wide">
                                Stock
                            </th>
                            <th class="wide">
                                revoke
                            </th>
                        </tr>
                        </thead>
    
                        <tbody id="non_revoked">
                            {% for med in pre_medicine %}
                            {% if med.revoked == False %}
                            <tr>
                                <td>
                                    {{med.id}}
                                </td>
                                <td>
                                    {{med.medicine_id}}
                                </td>
                                <td>
                                    {{med.quantity}}
                                </td>
                                <td>
                                    {{med.days}}
                                </td>
                                <td>
                                    {{med.times}}
                                </td>
                                <td>
                                    {{med.stock}}
                                </td>
                                <td>
                                    <label id="" for="{{med.id}}" value="">
                                        <input type="checkbox" id="{{med.id}}" name="{{med.id}}" value="revoke">
                                    </label>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
 
                    <div class="two fields">
                      <div class="field">
                          <label>Medicine</label>
    
                            <select class="ui search fluid dropdown" id="medicine_id_b" name="medicine_id_b" required="true">
                            <option value="" disabled selected>--SELECT--</option>
                            {% for medicine in medicine %}  
                            <option value="{{medicine.id}}">{{medicine.medicine_name}}</option>
                            {% endfor %}
                          </select>
                      </div>
    
                       <div class="field">
                         <label>Quantity</label>
                         <div class="ui fluid large input">
                             <input placeholder="Quantity" id="quantity_b" name="quantity_b" type="number">
    
                         </div>
                      </div>
                        <div class="field">
                          <label>No of days</label>
                          <div class="ui fluid large input">
                              <input placeholder="No of days" id="days_b" name="days_b" type="number">
    
                          </div>
                         </div>
                         <div class="field">
                           <label>Times per day</label>
                           <div class="ui fluid large input">
                               <input placeholder="No of times per day" id="times_b" name="times_b" type="number">
    
                           </div>
                        </div>
                        <div class="field">
                            <label>Stock</label>
                            <select class="ui search fluid dropdown" name="stock_b" id="stock_b" required="true">
                                <option value="" disabled selected>--SELECT--</option>
                              </select>
                         </div>
                         <div class="field">
                             <label><br></label>
                             <input type="button" id="medicine_b" name="medicine_b" value="Add"class="ui small left floated primary button" />
    
                         </div>
                    </div>
                    <table  class="ui very basic collapsing celled small fluid sortable table"
                           style="padding-left: 2.5%;padding-right: 2.5%;margin: auto;">
                        <thead>
                        <tr>
                            <th class="two wide">
                                Medicine
                            </th>
    
                            <th class="two wide" >
                                Quantity
                            </th>
    
                            <th class="wide">
                                Days
                            </th>
                            <th class="wide">
                                Times
                            </th>
                            <th class="wide">
                                Stock
                            </th>
                        </tr>
                        </thead>
    
                        <tbody id="sched_b">
                        </tbody>
                    </table>
                    <div class="field">
                        <label>Tests Suggested</label>
                        <textarea rows="2" id="tests_b" name="extra_meds" ></textarea>
                    </div>
                    <div class="field">
                        <label><br></label>
                        <input type="button" id="prescribe_b" name="prescribe"  value="Submit"class="ui large right floated primary button" />
                    </div>
                </form>
               </div></div>
               <script src="{% static 'globals/js/jquery.min.js' %}"></script>
               <script type="text/javascript">
                    
                    var form = document.getElementById('followup_form')
                    form.style.display="none"
                     
                    $("#add_followup").click(function(e){
                        form.style.display="block"
                        var button = document.getElementById('add_followup')
                        button.style.display="none"
                    })
                     $('#medicine_id_b').change(function(e){
                       $.ajax({
                           type:'post',
                           url:'/healthcenter/compounder/',
                           data:{
                               csrfmiddlewaretoken: '{{ csrf_token }}',
                               medicine_name_for_stock:$("#medicine_id_b").val(),
                               get_stock:1,
                           },
                           success: function(data){
                               var select_stock = document.getElementById("stock_b");
                               select_stock.options.length=0
                               $.each(data.val,function(key,value){
                                   let id=value.id;
                                   let med_name=value.med_name;
                                   let expiry=value.expiry;
                                   let supplier = value.supplier;
                                   let qty = value.quantity
                                   select_stock.options[select_stock.options.length] = new Option(med_name+" "+expiry+" "+supplier+" "+qty+" "+id);
                               });
                           }
                       });
                     });
   
                     $('#medicine_b').click(function(e){
                                                           var medicine = document.getElementById('medicine_id_b').value;
                                                           var quantity = document.getElementById('quantity_b').value;
                                                           var days = document.getElementById('days_b').value;
                                                           var times = document.getElementById('times_b').value;
                                                           var stock = document.getElementById('stock_b').value;
                                                           console.log(stock)
                                                           if(days=="" || days<0 || times=="" || times<0 || quantity=="" || quantity<0)
                                                           {
                                                           $('#usr_b').html("Enter Valid Information");
                                                           return false;
                                                           }
                                                           $.ajax({
                                                             type:'post',
                                                             url:'/healthcenter/compounder/',
                                                             data: {
                                                             csrfmiddlewaretoken: '{{ csrf_token }}',
                                                             user:$("#patient_b").val(),
                                                             quantity:$("#quantity_b").val(),
                                                             medicine_name_b:$("#medicine_id_b").val(),
                                                             days:$("#days_b").val(),
                                                             times:$("#times_b").val(),
                                                             stock:$("#stock_b").val()
                                                           },
                                                             success: function(data){
                                                                 var response=JSON.stringify(data);
                                                                 if(data.status==1){
                                                                       alert("added medicine");
                                                                       $('#sched_b').append("<tr><td>" + data.med_name + "</td><td>" +
                                                                       document.getElementById("quantity_b").value + "</td><td>" + document.getElementById("days_b").value + "</td><td>" + document.getElementById("times_b").value + "</td><td>"+ document.getElementById("stock_b").value + "</td></tr>");
                                                                  }
                                                                  else{
                                                                   alert("quantity exceeded the amount in selected stock")
                                                                  }
                                                                   document.getElementById("quantity_b").value="";
                                                                   document.getElementById("times_b").value="";
                                                                   document.getElementById("days_b").value="";
                                                                   document.getElementById("medicine_id_b").value="";
                                                               }
                                                         });
                                                       });
       </script>
       <script type="text/javascript">
                       $('#prescribe_b').click(function(e){
                                                       var user = document.getElementById('user').value;
                                                       var details = document.getElementById('details_b').value;
                                                       var tbl = document.getElementById('sched_b');
                                                       var medicine=[]
   
                                                       for(var i=0,row;row=tbl.rows[i];i++){
                                                           var obj= new Object();
                                                           obj.med_name=row.cells[0].innerText;
                                                           obj.quantity=row.cells[1].innerText;
                                                           obj.Days=row.cells[2].innerText;
                                                           obj.Times=row.cells[3].innerText;
                                                           obj.stock=row.cells[4].innerText;
                                                           medicine[i]=obj;
                                                           console.log(obj)
                                                       }
                                                       var tbl_r = document.getElementById('non_revoked');
                                                       console.log(tbl_r)
                                                       var revoked=[]

                                                       for(var i=0,row;row=tbl_r.rows[i];i++){
                                                            var obj = new Object;
                                                            var med_id = row.cells[0].innerText;
                                                            obj.med_id = med_id;
                                                            console.log(typeof med_id)
                                                            var check = document.getElementById(med_id);
                                                            console.log(check)
                                                            if(check.checked) obj.checked = 'true';
                                                            else obj.checked = 'false';
                                                            revoked[i]=obj;
                                                            console.log(obj)
                                                       }
   
                                                       console.log(medicine)
                                                        
                                                       // Get the file input element                                                       
                                                       // Get the files from the input element
                                                       
                                                       // Create a new FormData object
                                                       date="{{prescription.date}}"
                                                       console.log(date)
                                                       var formData = new FormData();
                                                       if(tbl.rows.length==0){
                                                       $('#usr_b').html("Please prescribe some medicine!");
                                                       return false;
                                                        }
                                                       if(user=="" || details=="")
                                                       {
                                                       $('#usr_b').html("Please enter all the details!");
                                                       return false;
                                                       }
                                                       formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                                                       formData.append('pre_id',"{{prescription.id}}");
                                                       formData.append('doctor', $("#doctor_b").val());
                                                       formData.append('details', $("#details_b").val());
                                                       formData.append('tests', $("#tests_b").val());
                                                       formData.append('presc_followup', $("#prescribe_b").val());
                                                       formData.append('pre_medicine',JSON.stringify(medicine));
                                                       formData.append('revoked',JSON.stringify(revoked));
                                                       $.ajax({
                                                         type:'post',
                                                         url:'/healthcenter/compounder/',
                                                         data: formData,
                                                         processData: false, // Don't process the data as a query string
                                                         contentType: false, // Let the browser set the Content-Type header automatically
                                                         success: function(data){
                                                           if (data.status == 1){
                                                             alert("prescribed medicine");
                                                             document.getElementById("doctor_b").value="";
                                                             document.getElementById("details_b").value="";
                                                             document.getElementById("tests_b").value="";
                                                             $('#sched_b').empty();
                                                             window.location.reload();
                                                           }
   
                                                           else {
                                                               if(data.status == 0)
                                                               alert("Prescription failed!, not enough medicine available in stock");
                                                               }
                                                       },
                                                     });
                                                     });
                 </script>
                {% endblock %}
            </div>
        </div>
        {% comment %}The central-rail segment ends here!{% endcomment %}

        {% comment %}The right-rail segment starts here!{% endcomment %}
        <div class="three wide column">
            {% comment %} <div class="row">
                {% block sidepanel %} {% include 'notifications/sidepanel.html' with notifications=notifications %}
                {% endblock %}
            </div> {% endcomment %}
        </div>
        {% comment %}The right-rail segment ends here!{% endcomment %}

    </div>
    <div class="ui stackable doubling grid">
        {% comment %}The right-margin segment!{% endcomment %}
        <div class="column"></div>

    </div>
    {% comment %}The grid ends here!{% endcomment %}

{% endblock %}

{% block javascript %}
    <script src="https://cdn.rawgit.com/mdehoog/Semantic-UI/6e6d051d47b598ebab05857545f242caf2b4b48c/dist/semantic.min.js"></script>
    <script type="text/javascript" src="{% static 'globals/js/datepicker.js' %}"></script>
    <script type="text/javascript" src="{% static 'globals/js/tablesort.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.22/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>

{% endblock %}